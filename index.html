<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Gestionale Scolastico</title>
<style>body{font-family:Arial;max-width:1000px;margin:auto;padding:18px} input,button{padding:8px;margin:6px 0}</style>
</head><body>
<h1>Gestionale Scolastico</h1>
<div id="login"><input id="username" placeholder="username"/><br/><input id="password" placeholder="password" type="password"/><br/><button onclick="login()">Accedi</button></div>
<div id="app" style="display:none">
  <div id="who"></div>
  <nav><button onclick="listStudents()">Studenti</button> <button onclick="openSummaryPrompt()">Voti/Media</button> <button onclick="openCollegio()">Collegio Docenti</button></nav>
  <div id="content"></div>
  <button onclick="logout()">Logout</button>
</div>
<script>
function headers(){ return {'Content-Type':'application/json','Authorization':'Bearer '+localStorage.getItem('token')} }
async function login(){ const u=document.getElementById('username').value, p=document.getElementById('password').value;
 const r=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})}); const j=await r.json();
 if(!r.ok){ alert(j.error||'Errore'); return;} localStorage.setItem('token', j.token); localStorage.setItem('user', JSON.stringify(j.user)); showApp(); }
function logout(){ localStorage.removeItem('token'); localStorage.removeItem('user'); document.getElementById('app').style.display='none'; document.getElementById('login').style.display='block'; }
function showApp(){ const user=JSON.parse(localStorage.getItem('user')||'null'); if(!user) return; document.getElementById('login').style.display='none'; document.getElementById('app').style.display='block'; document.getElementById('who').innerHTML='<b>'+user.name+'</b> ('+user.role+')'; }
async function listStudents(){ const r=await fetch('/api/students',{headers:headers()}); const list=await r.json();
 let html='<h3>Studenti</h3><table border=1 cellpadding=6><tr><th>ID</th><th>Nome</th><th>Classe</th></tr>'; list.forEach(s=> html+='<tr><td>'+s.id+'</td><td>'+s.first_name+' '+s.last_name+'</td><td>'+s.class+'</td></tr>'); html+='</table>'; document.getElementById('content').innerHTML=html; }
function openSummaryPrompt(){ const id=prompt('ID studente'); if(id) showSummary(id); }
async function showSummary(id){ const r=await fetch('/api/students/'+id+'/summary',{headers:headers()}); const j=await r.json(); if(!r.ok){ alert(j.error||'Errore'); return; } let html='<h3>'+j.student.first_name+' '+j.student.last_name+' ('+j.student.class+')</h3>'; html+='<p>Media: '+(j.overall||'N/A')+'</p>'; if(j.perSubject){ html += '<h4>Per materia</h4><ul>'; j.perSubject.forEach(p=> html+='<li>'+p.subject+': '+p.avg+' ('+p.count+')</li>'); html += '</ul>'; } if(j.grades.length){ html += '<h4>Voti recenti</h4><ul>'; j.grades.forEach(g=> html+='<li>'+g.subject+': '+g.score+'</li>'); html+='</ul>'; } document.getElementById('content').innerHTML=html; }
function openCollegio(){ document.getElementById('content').innerHTML='<h3>Collegio Docenti</h3><p>Qui si possono pubblicare convocazioni e documenti (demo)</p>'; }
window.addEventListener('load', ()=>{ if(localStorage.getItem('token')) showApp(); });
</script>
</html>
